<!DOCTYPE html>
<html>
<head>
    <title>Run Summary</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body>
    <h1>Run Summary</h1>

    <div class="summary-stats">
        <div class="stat-card">
            <div class="stat-label">Total Actual Time</div>
            <div class="stat-value">{{ summary.total_actual_time_formatted }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">
                {% if summary.has_coached_plan %}
                Coached Plan Time
                {% else %}
                Total Uncoached Time
                {% endif %}
            </div>
            <div class="stat-value">{{ summary.total_predicted_time_formatted }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Difference</div>
            <div class="stat-value {{ 'faster' if summary.total_difference_sec < 0 else 'slower' }}">
                {{ summary.difference_formatted }}
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Average Actual Pace</div>
            <div class="stat-value">{{ summary.avg_actual_pace }}</div>
        </div>
    </div>

    <h2>Pace Comparison by Segment</h2>
    <canvas id="pace-chart"></canvas>

    <h2>Performance Analysis</h2>
    <canvas id="difference-chart"></canvas>

    <h2>Elevation Profile</h2>
    <canvas id="elevation-chart"></canvas>

    <h2>Segment Details</h2>
    <table class="data">
        <thead>
            <tr>
                <th>Segment</th>
                {% if summary.has_coached_plan %}
                <th>Uncoached Pace</th>
                <th>Coached Pace</th>
                {% else %}
                <th>Uncoached Pace</th>
                {% endif %}
                <th>Actual Pace</th>
                <th>Difference</th>
            </tr>
        </thead>
        <tbody>
            {% for i in range(summary.segments|length) %}
            <tr>
                <td>{{ i + 1 }}</td>
                {% if summary.has_coached_plan %}
                <td>{{ summary.uncoached_paces_display[i] }}</td>
                <td>{{ summary.coached_paces_display[i] }}</td>
                {% else %}
                <td>{{ summary.predicted_paces_display[i] }}</td>
                {% endif %}
                <td>{{ summary.actual_paces_display[i] }}</td>
                <td class="{{ 'faster' if summary.differences[i] < 0 else 'slower' }}">
                    {{ summary.differences_display[i] }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="text-center mt-20">
        <a href="{{ url_for('deeper_analytics') }}" class="button button-success">View Deeper Analytics üîç</a>
        <a href="{{ url_for('index') }}" class="button button-primary">New Run</a>
    </div>

    <!--<div class="text-center mt-20">
        <a href="{{ url_for('index') }}" class="button button-primary">New Run</a>
    </div>-->

    <script>
        // Register the datalabels plugin
        Chart.register(ChartDataLabels);
        
        const segments = {{ summary.segments | tojson | safe }};
        
        // Convert decimal minutes to mm:ss format for display
        function formatPaceForChart(decimalMinutes) {
            const minutes = Math.floor(decimalMinutes);
            const seconds = Math.round((decimalMinutes - minutes) * 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Prepare actual paces (already in minutes)
        const actualPaces = {{ summary.actual_paces_min | tojson | safe }};
        
        {% if summary.has_coached_plan %}
        // When coaching was used, show all three lines
        const uncoachedPaces = {{ summary.uncoached_paces | tojson | safe }};
        const coachedPaces = {{ summary.coached_paces | tojson | safe }};
        
        const datasets = [
            {
                label: 'Actual Pace',
                data: actualPaces,
                borderColor: 'rgb(231, 76, 60)',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                borderWidth: 3,
                tension: 0.3,
                pointRadius: 5,
                datalabels: {
                    display: false
                }
            },
            {
                label: 'Uncoached Pace',
                data: uncoachedPaces,
                borderColor: 'rgb(149, 165, 166)',
                backgroundColor: 'rgba(149, 165, 166, 0.1)',
                borderWidth: 2,
                borderDash: [5, 5],
                tension: 0.3,
                pointRadius: 4,
                datalabels: {
                    display: false
                }
            },
            {
                label: 'Coached Pace',
                data: coachedPaces,
                borderColor: 'rgb(52, 152, 219)',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 4,
                datalabels: {
                    display: false
                }
            }
        ];
        {% else %}
        // When no coaching was used, show only two lines
        const predictedPaces = {{ summary.predicted_paces_min | tojson | safe }};
        
        const datasets = [
            {
                label: 'Actual Pace',
                data: actualPaces,
                borderColor: 'rgb(231, 76, 60)',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                borderWidth: 3,
                tension: 0.3,
                pointRadius: 5,
                datalabels: {
                    display: false
                }
            },
            {
                label: 'Uncoached Pace',
                data: predictedPaces,
                borderColor: 'rgb(52, 152, 219)',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 4,
                datalabels: {
                    display: false
                }
            }
        ];
        {% endif %}

        const ctx = document.getElementById('pace-chart').getContext('2d');

        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: segments,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.parsed.y;
                                const formattedPace = formatPaceForChart(value);
                                return `${label}: ${formattedPace} min/km`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Segment (km)',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Pace (min/km)',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            callback: function(value) {
                                return formatPaceForChart(value);
                            }
                        }
                    }
                }
            }
        });

        // Create diverging bar chart showing difference from coached/predicted pace
        const ctx2 = document.getElementById('difference-chart').getContext('2d');
        
        {% if summary.has_coached_plan %}
        // Calculate differences: actual - coached (negative = faster than coached)
        const paceDifferences = actualPaces.map((actual, i) => {
            return (actual - coachedPaces[i]) * 60; // Convert to seconds
        });
        const comparisonLabel = 'vs Coached Pace';
        {% else %}
        // Calculate differences: actual - predicted (negative = faster than predicted)
        const paceDifferences = actualPaces.map((actual, i) => {
            return (actual - predictedPaces[i]) * 60; // Convert to seconds
        });
        const comparisonLabel = 'vs Uncoached Pace';
        {% endif %}
        
        // Create colors array - green for negative (faster), red for positive (slower)
        const barColors = paceDifferences.map(diff => diff < 0 ? 'rgba(39, 174, 96, 0.8)' : 'rgba(231, 76, 60, 0.8)');
        const borderColors = paceDifferences.map(diff => diff < 0 ? 'rgb(39, 174, 96)' : 'rgb(231, 76, 60)');
        
        const differenceChart = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: segments,
                datasets: [{
                    label: `Pace Difference ${comparisonLabel}`,
                    data: paceDifferences,
                    backgroundColor: barColors,
                    borderColor: borderColors,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y;
                                const absValue = Math.abs(value);
                                const status = value < 0 ? 'faster' : 'slower';
                                return `${absValue.toFixed(0)}s ${status}`;
                            }
                        }
                    },
                    datalabels: {
                        display: true,
                        anchor: 'end',
                        align: function(context) {
                            // Labels appear above positive bars, below negative bars
                            return context.dataset.data[context.dataIndex] >= 0 ? 'top' : 'bottom';
                        },
                        formatter: function(value) {
                            // Format as +/-Xs (e.g., "+15s" or "-8s")
                            return (value > 0 ? '+' : '') + value.toFixed(0) + 's';
                        },
                        color: '#2c3e50',
                        font: {
                            weight: 'bold',
                            size: 11
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Segment (km)',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Time Difference (seconds)',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            callback: function(value) {
                                return (value > 0 ? '+' : '') + value + 's';
                            }
                        }
                    }
                }
            }
        });

        // Create elevation profile chart
        const ctx3 = document.getElementById('elevation-chart').getContext('2d');

        // Get elevation data from summary
        const elevationGain = {{ summary.elevation_gain | tojson | safe }};
        const elevationLoss = {{ summary.elevation_loss | tojson | safe }};
        const netElevation = elevationGain.map((gain, i) => gain - elevationLoss[i]);

        const elevationChart = new Chart(ctx3, {
            type: 'bar',
            data: {
                labels: segments,
                datasets: [{
                    label: 'Net Elevation Change',
                    data: netElevation,
                    backgroundColor: netElevation.map(elev => elev > 0 ? 'rgba(231, 76, 60, 0.7)' : 'rgba(52, 152, 219, 0.7)'),
                    borderColor: netElevation.map(elev => elev > 0 ? 'rgb(231, 76, 60)' : 'rgb(52, 152, 219)'),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y;
                                return value > 0 ? `+${value.toFixed(1)}m gain` : `${value.toFixed(1)}m loss`;
                            }
                        }
                    },
                    datalabels: {
                        display: true,
                        anchor: 'end',
                        align: function(context) {
                            // Labels appear above positive bars, below negative bars
                            return context.dataset.data[context.dataIndex] >= 0 ? 'top' : 'bottom';
                        },
                        formatter: function(value) {
                            // Format as +/-X.Xm (e.g., "+15.3m" or "-8.7m")
                            return (value > 0 ? '+' : '') + value.toFixed(1) + 'm';
                        },
                        color: '#2c3e50',
                        font: {
                            weight: 'bold',
                            size: 11
                        } 
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Segment (km)',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Net Elevation (m)',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            callback: function(value) {
                                return value > 0 ? '+' + value + 'm' : value + 'm';
                            }
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>